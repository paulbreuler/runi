name: Release Please

on:
  workflow_run:
    workflows: ['CI']
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    # Manual trigger option

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  check-ci-status:
    name: Verify CI Workflow Passed
    runs-on: ubuntu-latest
    outputs:
      ci-passed: ${{ steps.check.outputs.ci-passed }}
    steps:
      - name: Check CI workflow status or set default
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'workflow_run') {
              const workflowRun = context.payload.workflow_run;
              
              if (workflowRun.conclusion !== 'success') {
                core.setOutput('ci-passed', 'false');
                core.setFailed(`CI workflow did not pass. Conclusion: ${workflowRun.conclusion}`);
              } else {
                core.setOutput('ci-passed', 'true');
              }
            } else {
              // Manual trigger - allow to proceed
              core.setOutput('ci-passed', 'true');
            }

  release-please:
    name: Create Release PR
    runs-on: ubuntu-latest
    needs: check-ci-status
    if: |
      (github.event_name == 'workflow_run' && needs.check-ci-status.outputs.ci-passed == 'true') ||
      (github.event_name == 'workflow_dispatch' && needs.check-ci-status.outputs.ci-passed == 'true')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.json
