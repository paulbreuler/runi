name: Release Please

on:
  workflow_run:
    workflows: ['CI']
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_ci_check:
        description: 'Skip CI status check (use with caution)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  check-ci-status:
    name: Verify CI Workflow Passed
    runs-on: ubuntu-latest
    outputs:
      ci-passed: ${{ steps.check.outputs.ci-passed }}
    steps:
      - name: Check CI workflow status or set default
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'workflow_run') {
              const workflowRun = context.payload.workflow_run;
              
              if (workflowRun.conclusion !== 'success') {
                core.setOutput('ci-passed', 'false');
                core.setFailed(`CI workflow did not pass. Conclusion: ${workflowRun.conclusion}`);
              } else {
                core.setOutput('ci-passed', 'true');
              }
            } else {
              // Manual trigger - check if user explicitly skipped CI check
              const skipCiCheck = context.payload.inputs?.skip_ci_check === 'true';
              if (skipCiCheck) {
                core.setOutput('ci-passed', 'true');
                core.warning('CI check skipped by user - proceeding with release-please');
              } else {
                // For manual triggers without skip flag, check latest CI status
                const { data: workflows } = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'CI.yml',
                  branch: 'main',
                  per_page: 1
                });
                
                if (workflows.workflow_runs.length > 0) {
                  const latestRun = workflows.workflow_runs[0];
                  if (latestRun.conclusion === 'success') {
                    core.setOutput('ci-passed', 'true');
                  } else {
                    core.setOutput('ci-passed', 'false');
                    core.setFailed(`Latest CI workflow did not pass. Conclusion: ${latestRun.conclusion}. Use skip_ci_check input to bypass.`);
                  }
                } else {
                  core.setOutput('ci-passed', 'false');
                  core.setFailed('No CI workflow runs found. Use skip_ci_check input to bypass.');
                }
              }
            }

  release-please:
    name: Create Release PR
    runs-on: ubuntu-latest
    needs: check-ci-status
    if: needs.check-ci-status.outputs.ci-passed == 'true'
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.json

  build:
    name: Build ${{ matrix.os }}
    needs: release-please
    if: needs.release-please.outputs.release_created == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    env:
      CARGO_TERM_COLOR: always
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.tag_name }}

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Build Tauri app
        run: just build

      - name: Prepare release artifacts
        run: |
          # Create artifacts directory for this platform
          mkdir -p release-artifacts

          # Copy all bundle files (DMG, AppImage, deb, etc.)
          if [ -d "src-tauri/target/release/bundle" ]; then
            find src-tauri/target/release/bundle -type f \( -name "*.dmg" -o -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" \) -exec cp {} release-artifacts/ \;
          fi
        shell: bash

      - name: Check for artifacts
        id: check-artifacts
        run: |
          if ls release-artifacts/*.dmg release-artifacts/*.AppImage release-artifacts/*.deb release-artifacts/*.rpm 2>/dev/null | grep -q .; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: steps.check-artifacts.outputs.found == 'true'
        with:
          name: release-artifacts-${{ matrix.os }}
          path: release-artifacts/*
          retention-days: 7

  attach-artifacts:
    name: Attach Artifacts to Release
    needs: [release-please, build]
    if: always() && needs.release-please.outputs.release_created == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: release-artifacts-*
          merge-multiple: true
          path: release-artifacts

      - name: Check if artifacts exist
        id: check-artifacts
        run: |
          if [ -d "release-artifacts" ] && [ "$(ls -A release-artifacts 2>/dev/null)" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Attach artifacts to GitHub Release
        if: steps.check-artifacts.outputs.found == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: |
            release-artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
