name: Release Please

on:
  workflow_run:
    workflows: ['CI']
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_ci_check:
        description: 'Skip CI status check (use with caution)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  check-ci-status:
    name: Verify CI Workflow Passed
    runs-on: ubuntu-latest
    outputs:
      ci-passed: ${{ steps.check.outputs.ci-passed }}
    steps:
      - name: Check CI workflow status or set default
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'workflow_run') {
              const workflowRun = context.payload.workflow_run;
              
              if (workflowRun.conclusion !== 'success') {
                core.setOutput('ci-passed', 'false');
                core.setFailed(`CI workflow did not pass. Conclusion: ${workflowRun.conclusion}`);
              } else {
                core.setOutput('ci-passed', 'true');
              }
            } else {
              // Manual trigger - check if user explicitly skipped CI check
              const skipCiCheck = context.payload.inputs?.skip_ci_check === 'true';
              if (skipCiCheck) {
                core.setOutput('ci-passed', 'true');
                core.warning('CI check skipped by user - proceeding with release-please');
              } else {
                // For manual triggers without skip flag, check latest CI status
                const { data: workflows } = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: 'ci.yml',
                  branch: 'main',
                  per_page: 1
                });
                
                if (workflows.workflow_runs.length > 0) {
                  const latestRun = workflows.workflow_runs[0];
                  if (latestRun.conclusion === 'success') {
                    core.setOutput('ci-passed', 'true');
                  } else {
                    core.setOutput('ci-passed', 'false');
                    core.setFailed(`Latest CI workflow did not pass. Conclusion: ${latestRun.conclusion}. Use skip_ci_check input to bypass.`);
                  }
                } else {
                  core.setOutput('ci-passed', 'false');
                  core.setFailed('No CI workflow runs found. Use skip_ci_check input to bypass.');
                }
              }
            }

  release-please:
    name: Create Release
    runs-on: ubuntu-latest
    needs: check-ci-status
    if: needs.check-ci-status.outputs.ci-passed == 'true'
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      changelog: ${{ steps.release.outputs.body }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run release-please
        uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.json

      - name: Release summary
        run: |
          if [ "${{ steps.release.outputs.release_created }}" = "true" ]; then
            echo "✅ Release created for tag: ${{ steps.release.outputs.tag_name }}" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "ℹ️ No new release created. Release PR may have been created or updated." >> "$GITHUB_STEP_SUMMARY"
          fi
